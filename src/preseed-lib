#!/bin/sh

set -e
set -x

os_preseed_set_dbconfig_conf () {
	local PKG_NAME TMPL_NAME SQL_PASS DB_NAME DB_USER
	PKG_NAME=${1}
	TMPL_NAME=${2}
	SQL_PASS=${3}
	DB_NAME=${4}
	DB_USER=${5}
	echo "# automatically generated by the maintainer scripts of ${PKG_NAME}
# any changes you make will be preserved, though your comments
# will be lost!  to change your settings you should edit this
# file and then run \"dpkg-reconfigure ${PKG_NAME}\"

# dbc_install: configure database with dbconfig-common?
#              set to anything but \"true\" to opt out of assistance
dbc_install='true'

# dbc_upgrade: upgrade database with dbconfig-common?
#              set to anything but \"true\" to opt out of assistance
dbc_upgrade='true'

# dbc_remove: deconfigure database with dbconfig-common?
#              set to anything but \"true\" to opt out of assistance
dbc_remove=''

# dbc_dbtype: type of underlying database to use
#	this exists primarily to let dbconfig-common know what database
#	type to use when a package supports multiple database types.  
#	don't change this value unless you know for certain that this
#	package supports multiple database types
dbc_dbtype='mysql'

# dbc_dbuser: database user
#	the name of the user who we will use to connect to the database.
dbc_dbuser='"${DB_USER}"'

# dbc_dbpass: database user password
#	the password to use with the above username when connecting
#	to a database, if one is required
dbc_dbpass='"${SQL_PASS}"'

# dbc_dbserver: database host.  
#	leave unset to use localhost (or a more efficient local method
#	if it exists).
dbc_dbserver=''

# dbc_dbport: remote database port
#	leave unset to use the default.  only applicable if you are
#	using a remote database.
dbc_dbport=''

# dbc_dbname: name of database
#	this is the name of your application's database.
dbc_dbname='"${DB_NAME}"'

# dbc_dbadmin: name of the administrative user
#	this is the administrative user that is used to create all of the above
dbc_dbadmin='root'

# dbc_basepath: base directory to hold database files
#	leave unset to use the default.  only applicable if you are
#	using a local (filesystem based) database.    
dbc_basepath=''

##
## postgresql specific settings.  if you don't use postgresql,
## you can safely ignore all of these
##

# dbc_ssl: should we require ssl?
#	set to \"true\" to require that connections use ssl
dbc_ssl=''

# dbc_authmethod_admin: authentication method for admin
# dbc_authmethod_user: authentication method for dbuser
#	see the section titled \"AUTHENTICATION METHODS\" in
#	/usr/share/doc/dbconfig-common/README.pgsql for more info
dbc_authmethod_admin=''
dbc_authmethod_user=''

##
## end postgresql specific settings
##


" >/etc/dbconfig-common/${PKG_NAME}.conf
	echo "${PKG_NAME} ${TMPL_NAME}/configure_db boolean true
${PKG_NAME} ${TMPL_NAME}/configure_db seen true

${PKG_NAME} dbconfig-common/dbconfig-install boolean true
${PKG_NAME} dbconfig-common/dbconfig-install seen true
${PKG_NAME} dbconfig-common/dbconfig-reinstall boolean true
${PKG_NAME} dbconfig-common/dbconfig-reinstall seen true
${PKG_NAME} dbconfig-common/dbconfig-upgrade boolean true
${PKG_NAME} dbconfig-common/dbconfig-upgrade seen true
${PKG_NAME} dbconfig-common/database-type select mysql
${PKG_NAME} dbconfig-common/database-type seen true
${PKG_NAME} dbconfig-common/mysql/admin-user string root
${PKG_NAME} dbconfig-common/mysql/admin-user seen true
${PKG_NAME} dbconfig-common/mysql/admin-pass string ${MYSQL_PASSWORD}
${PKG_NAME} dbconfig-common/mysql/admin-pass seen true
${PKG_NAME} configure_db
" | debconf-set-selections
}

os_preseed_endpoint () {
	local PKG_NAME TMPL_NAME
	PKG_NAME=${1}
	TMPL_NAME=${2}
	echo "${1} ${2}/register-endpoint boolean true
${1} ${2}/register-endpoint seen true
${1} ${2}/keystone-ip string 127.0.0.1
${1} ${2}/keystone-ip seen true
${1} ${2}/keystone-auth-token password ${KEYSTONE_AUTH_TOKEN}
${1} ${2}/keystone-auth-token seen true
${1} ${2}/endpoint-ip string ${KEYSTONE_ENDPOINT_IP}
${1} ${2}/endpoint-ip seen true
${1} ${2}/region-name string ${KEYSTONE_REGION}
${1} ${2}/region-name seen true
" | debconf-set-selections
}

os_preseed_keystone_autotoken () {
	local PKG_NAME TMPL_NAME AUTH_HOST AUTH_TENANT_NAME AUTH_USERNAME AUTH_PASS
	PKG_NAME=${1}
	TMPL_NAME=${2}
	AUTH_HOST=${3}
	AUTH_TENANT_NAME=${4}
	AUTH_USERNAME=${5}
	AUTH_PASS=${6}
	echo "${PKG_NAME} ${TMPL_NAME}/auth-host string ${AUTH_HOST}
${PKG_NAME} ${TMPL_NAME}/auth-host seen true
${PKG_NAME} ${TMPL_NAME}/admin-tenant-name string ${AUTH_TENANT_NAME}
${PKG_NAME} ${TMPL_NAME}/admin-tenant-name seen true
${PKG_NAME} ${TMPL_NAME}/admin-user string ${AUTH_USERNAME}
${PKG_NAME} ${TMPL_NAME}/admin-user seen true
${PKG_NAME} ${TMPL_NAME}/admin-password password ${AUTH_PASS}
${PKG_NAME} ${TMPL_NAME}/admin-password seen true
" | debconf-set-selections
}

os_preseed_rabbit_creds () {
	local PKG_NAME TMPL_NAME RBT_HOST RBT_LOGIN RBT_PASS
	PKG_NAME=${1}
	TMPL_NAME=${2}
	RBT_HOST=${3}
	RBT_LOGIN=${4}
	RBT_PASS=${5}
	echo "${PKG_NAME} ${TMPL_NAME}/rabbit_host string ${RBT_HOST}
${PKG_NAME} ${TMPL_NAME}/rabbit_host seen true
${PKG_NAME} ${TMPL_NAME}/rabbit_userid string ${RBT_LOGIN}
${PKG_NAME} ${TMPL_NAME}/rabbit_userid seen true
${PKG_NAME} ${TMPL_NAME}/rabbit_password password ${RBT_PASS}
${PKG_NAME} ${TMPL_NAME}/rabbit_password seen true
" | debconf-set-selections
}
